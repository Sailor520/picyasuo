<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Format Support Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .format-test {
            display: flex;
            gap: 20px;
            margin: 10px 0;
            align-items: center;
        }
        .preview {
            max-width: 100px;
            max-height: 100px;
            border: 1px solid #ccc;
        }
        input[type="file"] {
            margin: 10px 0;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
        }
        button:hover {
            background-color: #0056b3;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <h1>JPG to Small - Image Format Support Test</h1>
    
    <div class="test-section">
        <h2>Canvas API Format Support Test</h2>
        <p>This test checks which image formats can be processed by HTML5 Canvas API for compression.</p>
        
        <div id="canvasSupport" class="test-result info">
            Testing Canvas API support...
        </div>
        
        <input type="file" id="testFileInput" accept="image/*" multiple>
        <button onclick="runFormatTests()">Test Selected Files</button>
        <button onclick="createTestImages()">Create Test Images</button>
        
        <div id="testResults"></div>
    </div>

    <div class="test-section">
        <h2>Format-Specific Tests</h2>
        <div id="formatTests">
            <div class="format-test">
                <strong>JPG/JPEG:</strong> <span id="jpegResult">Not tested</span>
            </div>
            <div class="format-test">
                <strong>PNG:</strong> <span id="pngResult">Not tested</span>
            </div>
            <div class="format-test">
                <strong>WebP:</strong> <span id="webpResult">Not tested</span>
            </div>
            <div class="format-test">
                <strong>GIF:</strong> <span id="gifResult">Not tested</span>
            </div>
            <div class="format-test">
                <strong>SVG:</strong> <span id="svgResult">Not tested</span>
            </div>
        </div>
    </div>

    <script>
        // Test Canvas API support
        function testCanvasSupport() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const supportDiv = document.getElementById('canvasSupport');
            
            if (canvas && ctx) {
                supportDiv.innerHTML = '✅ Canvas API is supported';
                supportDiv.className = 'test-result success';
                
                // Test toBlob support
                if (canvas.toBlob) {
                    supportDiv.innerHTML += '<br>✅ Canvas.toBlob() is supported';
                } else {
                    supportDiv.innerHTML += '<br>❌ Canvas.toBlob() is NOT supported';
                    supportDiv.className = 'test-result warning';
                }
                
                // Test JPEG export support
                try {
                    const testData = canvas.toDataURL('image/jpeg', 0.8);
                    if (testData.startsWith('data:image/jpeg')) {
                        supportDiv.innerHTML += '<br>✅ JPEG export is supported';
                    } else {
                        supportDiv.innerHTML += '<br>❌ JPEG export may not be supported';
                    }
                } catch (e) {
                    supportDiv.innerHTML += '<br>❌ JPEG export error: ' + e.message;
                }
            } else {
                supportDiv.innerHTML = '❌ Canvas API is NOT supported';
                supportDiv.className = 'test-result error';
            }
        }

        // Test individual file
        function testImageFile(file) {
            return new Promise((resolve) => {
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                img.onload = function() {
                    try {
                        canvas.width = Math.min(img.width, 200);
                        canvas.height = Math.min(img.height, 200);
                        
                        // Draw image to canvas
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        // Try to export as JPEG
                        canvas.toBlob((blob) => {
                            if (blob) {
                                resolve({
                                    success: true,
                                    originalSize: file.size,
                                    compressedSize: blob.size,
                                    format: file.type,
                                    compressionRatio: ((file.size - blob.size) / file.size * 100).toFixed(1)
                                });
                            } else {
                                resolve({
                                    success: false,
                                    error: 'Failed to create compressed blob',
                                    format: file.type
                                });
                            }
                        }, 'image/jpeg', 0.8);
                        
                    } catch (error) {
                        resolve({
                            success: false,
                            error: 'Canvas drawing error: ' + error.message,
                            format: file.type
                        });
                    }
                };
                
                img.onerror = function() {
                    resolve({
                        success: false,
                        error: 'Failed to load image',
                        format: file.type
                    });
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        // Run tests on selected files
        async function runFormatTests() {
            const fileInput = document.getElementById('testFileInput');
            const resultsDiv = document.getElementById('testResults');
            
            if (!fileInput.files.length) {
                resultsDiv.innerHTML = '<div class="test-result warning">Please select some image files to test.</div>';
                return;
            }
            
            resultsDiv.innerHTML = '<div class="test-result info">Testing files...</div>';
            
            const results = [];
            for (let file of fileInput.files) {
                const result = await testImageFile(file);
                results.push({...result, fileName: file.name});
            }
            
            // Display results
            let html = '<h3>Test Results:</h3>';
            results.forEach(result => {
                const className = result.success ? 'success' : 'error';
                html += `<div class="test-result ${className}">
                    <strong>${result.fileName}</strong> (${result.format})<br>
                    ${result.success ? 
                        `✅ Successfully compressed<br>
                         Original: ${(result.originalSize/1024).toFixed(2)} KB<br>
                         Compressed: ${(result.compressedSize/1024).toFixed(2)} KB<br>
                         Compression: ${result.compressionRatio}%` :
                        `❌ Failed: ${result.error}`
                    }
                </div>`;
            });
            
            resultsDiv.innerHTML = html;
            
            // Update format-specific results
            updateFormatResults(results);
        }

        // Update format-specific test results
        function updateFormatResults(results) {
            const formatMap = {
                'image/jpeg': 'jpegResult',
                'image/jpg': 'jpegResult',
                'image/png': 'pngResult',
                'image/webp': 'webpResult',
                'image/gif': 'gifResult',
                'image/svg+xml': 'svgResult'
            };
            
            // Reset all results
            Object.values(formatMap).forEach(id => {
                document.getElementById(id).innerHTML = 'Not tested';
            });
            
            // Update based on test results
            results.forEach(result => {
                const elementId = formatMap[result.format];
                if (elementId) {
                    const element = document.getElementById(elementId);
                    element.innerHTML = result.success ? 
                        `✅ Supported (${result.compressionRatio}% compression)` : 
                        `❌ Failed: ${result.error}`;
                }
            });
        }

        // Create test images programmatically
        function createTestImages() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 200;
            canvas.height = 200;
            
            // Create a test pattern
            ctx.fillStyle = '#ff6b6b';
            ctx.fillRect(0, 0, 100, 100);
            ctx.fillStyle = '#4ecdc4';
            ctx.fillRect(100, 0, 100, 100);
            ctx.fillStyle = '#45b7d1';
            ctx.fillRect(0, 100, 100, 100);
            ctx.fillStyle = '#f9ca24';
            ctx.fillRect(100, 100, 100, 100);
            
            // Test different export formats
            const formats = [
                { type: 'image/jpeg', ext: 'jpg' },
                { type: 'image/png', ext: 'png' },
                { type: 'image/webp', ext: 'webp' }
            ];
            
            let html = '<h3>Generated Test Images:</h3>';
            
            formats.forEach(format => {
                try {
                    const dataURL = canvas.toDataURL(format.type, 0.8);
                    if (dataURL.startsWith(`data:${format.type}`)) {
                        html += `<div class="test-result success">
                            ✅ ${format.type} export supported
                            <br><img src="${dataURL}" class="preview" alt="Test ${format.ext}">
                        </div>`;
                    } else {
                        html += `<div class="test-result warning">
                            ⚠️ ${format.type} export may fall back to PNG
                        </div>`;
                    }
                } catch (e) {
                    html += `<div class="test-result error">
                        ❌ ${format.type} export failed: ${e.message}
                    </div>`;
                }
            });
            
            document.getElementById('testResults').innerHTML = html;
        }

        // Run initial tests
        window.onload = function() {
            testCanvasSupport();
        };
    </script>
</body>
</html>
